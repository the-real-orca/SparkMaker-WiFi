<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="style.css">
	<script src="js/vue.js"></script>
	<title>SparkMaker WiFi Interface</title>
</head>
<body>
	<div id="app">
		<h1>SparkMaker WiFi Interface</h1>
		<div id="printer">
			<div id="printer-img">
				<div id="printer-top">
					<div id="status">{{statusText}}</div>
					<div v-if="spark.status=='PRINTING' || spark.status=='PAUSE' || spark.status=='FINISHED'">
						<div id="percent">{{percent}}%</div>
						<div id="layer">({{spark.currentLayer}} / {{spark.totalLayers}})</div>
					</div>
				</div>
				<div id="printer-bottom" class="p-1">
					<div id="indicator" :class="spark.status" @click="indicator"></div>
					<div id="sd-slot"></div>
					
				</div>
			</div>

			<fieldset class="move center" :disabled="!(spark.status=='STANDBY'  || spark.status=='PAUSE' || spark.status=='FINISHED' || spark.status=='FILELIST' || spark.status=='NO_CARD')">
				<legend>Z-Axis</legend>
				<button @click="move(10)">+10</button><br>
				<button @click="move(5)">+5</button><br>
				<br>
				<button @click="move(-5)">-5</button><br>
				<button @click="move(-10)">-10</button><br>
				<br>
				<button @click="home" class="home">Home</button><br>
			</fieldset>
	
		</div>

		<fieldset class="control center">
			<div class="fileselect">
				<label>file:</label>
				<select v-model="selectedFile" v-if="spark.status=='STANDBY' || spark.status=='FINISHED'"  class="filename">
					<option v-for="file in spark.fileList">{{file}}</option>					
				</select>
				<span v-else class="filename">{{spark.currentFile}}</span>
			</div>
			<div class="command">
				<div v-if="spark.status=='PRINTING'">
					<button @click="pause">Pause</button> <button @click="stop">Stop</button>
				</div>
				<div v-else-if="spark.status=='PAUSE'">
					<button @click="resume">Resume</button> <button @click="stop">Stop</button>
				</div>
				<div v-else >
					<button @click="start" class="primary" :disabled="!printable">Print</button>
				</div>
			</div>
		</fieldset>

	</div>

	<script>
		var app = new Vue({
			el: "#app",
			data: {
				url: "", //	 "http://sparkmaker.local/",
				spark: {},
				selectedFile: ""

			},
			computed: {
				percent() { 
					return this.spark.totalLayers > 0 ? (this.spark.currentLayer / this.spark.totalLayers *100).toFixed(0) : '---' ; 
				},
				printable() {
					return (this.spark.status=='STANDBY' || this.spark.status=='FINISHED') && (this.selectedFile!="");
				},
				statusText() {
					switch (this.spark.status) {
						case "DISCONNECTED":
							return "offline";
						case "CONNECTING":
							return "connecting ...";
						case "STANDBY":
							return "standby";
						case "FILELIST":
							return "get filelist";
						case "PRINTING":
							return "printing ...";
						case "PAUSE":
							return "pause";
						case "FINISHED":
							return "finished";
						case "STOPPING":
							return "stopping";
						case "NO_CARD":
							return "no SD card";
						case "UPDATING":
							return "updating";			
					}

				}
			},
			mounted() {
				// fetch initial status
				this.update();

				// periodic update
				setInterval(this.update, 1000);
			},
			methods: {
				indicator() {
					if (this.spark.status=='STANDBY') return this.start();
					if (this.spark.status=='PRINTING') return this.pause();
					if (this.spark.status=='PAUSE') return this.resume();
				},
				connect() { fetch(this.url + "connect"); },
				disconnect() { fetch(this.url + "disconnect"); },
				update() {
					fetch(this.url + "status")
						.then(response => response.json())
						.then(json => {
							this.spark = json;

							// force selected file during print
							if ( this.spark.status!='STANDBY' && spark.status!='FINISHED' ) {
								this.selectedFile = this.spark.currentFile;
							}
							// test if selected file is available
							if ( this.spark.fileList.indexOf( this.selectedFile ) < 0 ||
								this.spark.status=='DISCONNECTED' || this.spark.status=='CONNECTING' || this.spark.status=='NO_CARD' ) {
									this.selectedFile = "";
							}

						})
						.catch(err => {});
				},
				move(pos) {
					var formData = new FormData();
					formData.append("pos", pos);
					fetch(this.url + "move", { method: 'POST', body: formData });
				},
				backlight(pwm) {
					var formData = new FormData();
					formData.append("cmd", "M106 S" + pwm + ";");
					fetch(this.url + "send", { method: 'POST', body: formData });
				},
				home() { fetch(this.url + "home");	},
				emergency() { fetch(this.url + "emergencyStop"); },
				start() { 
					var formData = new FormData();
					formData.append("file", this.selectedFile);
					fetch(this.url + "print", { method: 'POST', body: formData });
				},
				stop() { fetch(this.url + "stop"); },
				pause() { fetch(this.url + "pause"); },
				resume() { fetch(this.url + "resume");	},
				requestStatus() { fetch(this.url + "requestStatus"); }
			}
		})    
	</script>
</body>

</html>